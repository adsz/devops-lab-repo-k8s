Vagrant.configure("2") do |config|
    config.vm.box = "ubuntu/jammy64"
  
    config.vm.provider "virtualbox" do |vb|
      vb.memory = 4096
      vb.cpus = 2
    end
  
    config.ssh.insert_key = false
    config.ssh.forward_agent = true
    config.ssh.extra_args = ["-o", "StrictHostKeyChecking=no"]
  
    config.vm.define "k8s-master" do |master|
      master.vm.hostname = "k8s-master"
      master.vm.network "private_network", ip: "10.0.0.10"
      master.vm.network "public_network", ip: "192.168.0.180", bridge: "eno1", auto_config: false
      master.vm.network "forwarded_port", guest: 22, host: 2221, id: "ssh"
  
      master.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-master"
        vb.customize ["modifyvm", :id, "--description", "role=master ansible=yes"]
      end
  
      master.vm.provision "shell", inline: <<-SHELL
        set -x  # Enable debug output
        sleep 10
        sudo ip link set enp0s9 up
        sudo rm -f /etc/netplan/*.yaml
        cat <<EOF | sudo tee /etc/netplan/99-vagrant.yaml
  network:
    version: 2
    ethernets:
      enp0s8:
        addresses: [10.0.0.10/24]
      enp0s9:
        addresses: [192.168.0.180/24]
        routes:
          - to: 0.0.0.0/0
            via: 192.168.0.1
        nameservers:
          addresses: [8.8.8.8, 1.1.1.1]
EOF
        sudo chmod 600 /etc/netplan/99-vagrant.yaml
        sudo netplan apply 2>&1 | tee /tmp/netplan.log
        sudo ip addr add 192.168.0.180/24 dev enp0s9 2>&1 | tee /tmp/ip.log
        sudo ip route add default via 192.168.0.1 2>&1 | tee /tmp/route.log
        ip a | tee /tmp/ip_after.log
  
        sudo sed -i 's/^#\\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh
  
        sudo useradd -m -s /bin/bash -G sudo ansible
        sudo mkdir -p /home/ansible/.ssh
        echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCzfxuuZ5G4k4eUQnzFaMJWYD5Zlepxduurf4F5zv8vUDo6a90bbGzJuDraKhRHeooYKd4HJH2KMEXF4upqFIVXpjmiRosN6b6/cc0Vl0x1UiL2Ukkgi09RSOGEexfeQx/MaNrGXOU2SW4Zx2eSmdusLMNp//D88W1YZbqKehOFOfXD1sa2RVz249TTm0ukebvZaOYinbH8yRcETfz9E3QLyRmbVQm+ZQ7zmJeFlOC3wvBwHDlMSK/dfWQ0mVg0Y12QLjrMATXnf9lCcuLRgPd4H+fECwyQqDamNMHkUsLNTWSVybcWimTPSbJssd0kl9FfNexBoD99Tua6r6yo4jaTqXEECAE9SveShpmZ2mDPQT4+VeXyVTsn/VZX8on7BrqTOYNMvHqdh8SuuKHsh6CyWsDN9gm0DxDwMPM9XsydKfM353uoSf/OKD1fv3h/C4P+CYHvsFnjxQyo72IceF3eiZt8T+NrxorV6ZvzXdGE/mUV/wn7x2opJfCzZNp0jJs=' | sudo tee /home/ansible/.ssh/authorized_keys
        sudo chmod 600 /home/ansible/.ssh/authorized_keys
        sudo chown -R ansible:ansible /home/ansible/.ssh
  
        echo "ansible ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ansible
        sudo chmod 440 /etc/sudoers.d/ansible
  
        echo -e "Host *\\n  StrictHostKeyChecking no\\n  UserKnownHostsFile=/dev/null" | sudo tee /home/ansible/.ssh/config
        sudo chown ansible:ansible /home/ansible/.ssh/config
        sudo chmod 600 /home/ansible/.ssh/config
      SHELL
    end
  end